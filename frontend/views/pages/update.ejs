<%- include('../partials/head') %>
<%- include('../partials/header') %>
<%- include('../partials/messages') %>

<style>
  /* Edit Product Page - Contact Page Style */
  .form-container {
    background: linear-gradient(135deg, #fff 0%, #fefefe 100%);
    border: 2px solid #e0bf50;
    border-radius: 15px;
    padding: 40px;
    box-shadow: 0 8px 25px rgba(224, 191, 80, 0.1);
    transition: transform 0.3s ease;
    margin-bottom: 30px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }

  .form-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(224, 191, 80, 0.15);
  }

  .page-title {
    color: #2c2c2c;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 30px;
    text-align: center;
  }

  .form-section {
    background: #fff;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
  }

  .section-title {
    color: #2c2c2c;
    font-weight: 600;
    font-size: 1.3rem;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 4px solid #e0bf50;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-icon {
    color: #e0bf50;
    font-size: 1.2rem;
  }

  .form-label {
    font-weight: 600;
    color: #2c2c2c;
    margin-bottom: 8px;
    font-size: 1rem;
  }

  .form-control, .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .form-control:focus, .form-select:focus {
    border-color: #e0bf50;
    box-shadow: 0 0 0 0.2rem rgba(224, 191, 80, 0.25);
  }

  .btn-primary-gold {
    background: linear-gradient(135deg, #e0bf50, #ffc107);
    border: none;
    color: #000;
    font-weight: 600;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 1rem;
    width: 100%;
    margin-top: 20px;
  }

  .btn-primary-gold:hover {
    background: linear-gradient(135deg, #ffc107, #ffed4e);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(224, 191, 80, 0.3);
    color: #000;
  }

  .back-button {
    margin-bottom: 20px;
  }

  .image-preview-container {
    background: rgba(224, 191, 80, 0.05);
    border: 2px dashed #e0bf50;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
  }

  .image-preview-container:hover {
    background: rgba(224, 191, 80, 0.1);
  }

  .current-image, .new-image-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(224, 191, 80, 0.2);
  }

  .price-toggle {
    background: rgba(224, 191, 80, 0.05);
    border: 2px solid #e0bf50;
    border-radius: 8px;
    padding: 15px;
  }

  .form-check-input:checked {
    background-color: #e0bf50;
    border-color: #e0bf50;
  }

  .input-group-text {
    background: linear-gradient(135deg, #e0bf50, #ffc107);
    border: 2px solid #e0bf50;
    color: #000;
    font-weight: 600;
  }

  /* Mobile Responsiveness */
  @media (max-width: 768px) {
    .form-container {
      margin: 0 15px;
      padding: 25px;
    }
    
    .page-title {
      font-size: 2rem;
    }
    
    .form-section {
      padding: 20px;
    }
  }

  /* Animation for page load */
  @keyframes fadeInUp {
    from { 
      opacity: 0; 
      transform: translateY(30px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }

  .form-container {
    animation: fadeInUp 0.6s ease-out;
  }
</style>

<a type="button" class="btn btn-outline-warning back-button" href="/products/<%= product._id %>">
  <i class="fa-solid fa-arrow-left"></i>
</a>

<div class="container mt-4">
  <div class="form-container">
    <h2 class="page-title lang" data-en="Edit Product" data-hi="उत्पाद संपादित करें">Edit Product</h2>

    <form class="needs-validation" id="editProductForm" action="/products/<%= product._id %>?_method=PUT" method="POST" enctype="multipart/form-data" novalidate>
      
      <!-- Basic Information Section -->
      <div class="form-section">
        <h4 class="section-title">
          <i class="fas fa-info-circle section-icon"></i>
          <span class="lang" data-en="Basic Information" data-hi="बुनियादी जानकारी">Basic Information</span>
        </h4>
        
        <div class="mb-3">
          <label for="name" class="form-label lang" data-en="Product Name" data-hi="उत्पाद का नाम">Product Name</label>
          <input type="text" class="form-control" id="name" name="name" value="<%= product.name %>" required>
          <div class="invalid-feedback">Please enter the product name.</div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="category" class="form-label lang" data-en="Category" data-hi="श्रेणी">Category</label>
            <select class="form-select" id="category" name="category" required>
              <option disabled value="">Select Category</option>
              <% categories.forEach(cat => { %>
                <option value="<%= cat._id %>" <%= product.category?.toString() === cat._id.toString() ? 'selected' : '' %>>
                  <%= cat.icon %> <%= cat.name.charAt(0).toUpperCase() + cat.name.slice(1) %>
                </option>
              <% }) %>
            </select>
            <div class="invalid-feedback">Please select a category.</div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="material" class="form-label lang" data-en="Material" data-hi="सामग्री">Material</label>
            <select class="form-select" id="material" name="material" required>
              <option value="">Select Material</option>
              <option value="gold" <%= product.material === 'gold' ? 'selected' : '' %>>Gold</option>
              <option value="silver" <%= product.material === 'silver' ? 'selected' : '' %>>Silver</option>
            </select>
            <div class="invalid-feedback">Please select a material.</div>
          </div>
        </div>

        <div class="mb-3">
          <label for="description" class="form-label lang" data-en="Description" data-hi="विवरण">Description</label>
          <textarea class="form-control" id="description" name="description" rows="3" required><%= product.description %></textarea>
          <div class="invalid-feedback">Please enter a description.</div>
        </div>
      </div>

      <!-- Pricing Section -->
      <div class="form-section">
        <h4 class="section-title">
          <i class="fas fa-tag section-icon"></i>
          <span class="lang" data-en="Pricing" data-hi="मूल्य निर्धारण">Pricing</span>
        </h4>
        
        <div class="price-toggle mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="isManualPrice" name="isManualPrice" <%= product.isManualPrice ? 'checked' : '' %>>
            <label class="form-check-label" for="isManualPrice">
              <span class="lang" data-en="Set Manual Price" data-hi="मैन्युअल मूल्य सेट करें">Set Manual Price</span>
            </label>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <div id="autoPriceField">
              <label for="autoPrice" class="form-label lang" data-en="Auto Price (₹)" data-hi="स्वचालित मूल्य (₹)">Auto Price (₹)</label>
              <input type="text" class="form-control" id="autoPrice" name="autoPrice" value="<%= !product.isManualPrice ? product.price.toFixed(2) : '' %>" readonly>
            </div>
            <div class="d-none" id="manualPriceField">
              <label for="manualPrice" class="form-label lang" data-en="Manual Price (₹)" data-hi="मैन्युअल मूल्य (₹)">Manual Price (₹)</label>
              <input type="number" step="0.01" min="0" class="form-control" id="manualPrice" name="manualPrice" value="<%= product.isManualPrice ? product.price : '' %>">
            </div>
          </div>
        </div>
      </div>

      <!-- Specifications Section -->
      <div class="form-section">
        <h4 class="section-title">
          <i class="fas fa-cogs section-icon"></i>
          <span class="lang" data-en="Specifications" data-hi="विशेष विवरण">Specifications</span>
        </h4>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="weight" class="form-label lang" data-en="Weight" data-hi="वजन">Weight</label>
            <div class="input-group">
              <input type="number" class="form-control" id="weight" name="specifications[weight]" step="0.01" min="0" value="<%= product.specifications?.weight || '' %>" required>
              <span class="input-group-text">gm</span>
            </div>
            <div class="invalid-feedback">Please enter the weight in grams.</div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="size" class="form-label lang" data-en="Size" data-hi="आकार">Size</label>
            <input type="text" class="form-control" id="size" name="specifications[size]" value="<%= product.specifications?.size || '' %>">
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="metalPurity" class="form-label lang" data-en="Metal Purity" data-hi="धातु शुद्धता">Metal Purity</label>
            <input type="text" class="form-control" id="metalPurity" name="specifications[metalPurity]" value="<%= product.specifications?.metalPurity || '' %>">
              </div>

          <div class="col-md-6 mb-3">
            <label for="gemstone" class="form-label lang" data-en="Gemstone" data-hi="रत्न">Gemstone</label>
            <input type="text" class="form-control" id="gemstone" name="specifications[gemstone]" value="<%= product.specifications?.gemstone || '' %>">
          </div>
        </div>
      </div>

      <!-- Product Status Section -->
      <div class="form-section">
        <h4 class="section-title">
          <i class="fas fa-toggle-on section-icon"></i>
          <span class="lang" data-en="Product Status" data-hi="उत्पाद स्थिति">Product Status</span>
        </h4>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="featured" name="featured" <%= product.featured ? 'checked' : '' %>>
              <label class="form-check-label" for="featured">
                <span class="lang" data-en="Featured Product" data-hi="फीचर्ड उत्पाद">Featured Product</span>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="inStock" name="inStock" <%= product.inStock ? 'checked' : '' %>>
              <label class="form-check-label" for="inStock">
                <span class="lang" data-en="In Stock" data-hi="स्टॉक में">In Stock</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Image Upload Section -->
      <div class="form-section">
        <h4 class="section-title">
          <i class="fas fa-image section-icon"></i>
          <span class="lang" data-en="Product Image" data-hi="उत्पाद छवि">Product Image</span>
        </h4>
        
        <!-- Current Image -->
        <% if (product.image) { %>
          <div class="image-preview-container mb-3">
            <label class="form-label lang" data-en="Current Image" data-hi="वर्तमान छवि">Current Image</label>
            <div class="text-center">
              <img src="<%= product.image %>" alt="Current product image" class="current-image">
            </div>
          </div>
        <% } %>

        <!-- New Image Upload -->
        <div class="mb-3">
          <label for="image" class="form-label lang" data-en="Upload New Image (Optional)" data-hi="नई छवि अपलोड करें (वैकल्पिक)">Upload New Image (Optional)</label>
          <input type="file" class="form-control" id="image" name="image" accept="image/*">
          <div class="form-text">
            <span class="lang" data-en="Supported formats: JPG, PNG, WEBP. Max size: 5MB" data-hi="समर्थित प्रारूप: JPG, PNG, WEBP। अधिकतम आकार: 5MB">Supported formats: JPG, PNG, WEBP. Max size: 5MB</span>
          </div>
        </div>

        <!-- New Image Preview -->
        <div id="newImagePreview" class="image-preview-container" style="display: none;">
          <label class="form-label lang" data-en="New Image Preview" data-hi="नई छवि पूर्वावलोकन">New Image Preview</label>
          <div class="text-center">
            <img id="newImageThumbnail" class="new-image-preview">
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <button type="submit" class="btn-primary-gold">
        <i class="fas fa-save me-2"></i>
        <span class="lang" data-en="Update Product" data-hi="उत्पाद अपडेट करें">Update Product</span>
      </button>
      </form>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const isManualPriceEl = document.getElementById('isManualPrice');
    const manualField = document.getElementById('manualPriceField');
    const autoField = document.getElementById('autoPriceField');
    const manualInput = document.getElementById('manualPrice');
    const autoInput = document.getElementById('autoPrice');
    const materialEl = document.getElementById('material');
    const weightEl = document.getElementById('weight');
    const form = document.getElementById('editProductForm');

    // Bootstrap validation
    form.addEventListener('submit', function(event) {
      // Recalculate auto price before validation
      recalcAutoPrice();

      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);

    function recalcAutoPrice() {
      const weight = parseFloat(weightEl.value);
      const material = materialEl.value;
      if (!weight || weight <= 0 || !material) {
        autoInput.value = '';
        return;
      }

      const metalsData = JSON.parse(localStorage.getItem('metalsData'));
      if (!metalsData) {
        autoInput.value = '';
        return;
      }

      let ratePerGram = 0;

      // Use lowercase comparison
      if (material === "gold" && metalsData.gold) {
        ratePerGram = metalsData.gold.ratePerGram;
      } else if (material === "silver" && metalsData.silver) {
        ratePerGram = metalsData.silver.ratePerGram;
      } else {
        autoInput.value = '';
        return;
      }

      const price = ratePerGram * weight;
      autoInput.value = ratePerGram > 0 ? price.toFixed(2) : '0.00';
    }

    function togglePriceFields() {
      const isManual = isManualPriceEl.checked;
      if (isManual) {
        manualField.classList.remove('d-none');
        autoField.classList.add('d-none');
        manualInput.required = true;
        autoInput.required = false;
      } else {
        manualField.classList.add('d-none');
        autoField.classList.remove('d-none');
        manualInput.required = false;
        autoInput.required = true;
        recalcAutoPrice();
      }
    }

    isManualPriceEl.addEventListener('change', togglePriceFields);
    materialEl.addEventListener('change', recalcAutoPrice);
    weightEl.addEventListener('input', recalcAutoPrice);

    togglePriceFields();
    recalcAutoPrice();

    // Image preview
    const imageInput = document.getElementById('image');
    const newImagePreview = document.getElementById('newImagePreview');
    const newImageThumbnail = document.getElementById('newImageThumbnail');

    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
          alert('Please select a valid image file (JPG, PNG, WEBP)');
          imageInput.value = '';
          newImagePreview.style.display = 'none';
          return;
        }
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
          alert('File size must be less than 5MB');
          imageInput.value = '';
          newImagePreview.style.display = 'none';
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          newImageThumbnail.src = e.target.result;
          newImagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        newImagePreview.style.display = 'none';
      }
    });
  });
</script>
